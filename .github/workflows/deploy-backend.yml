name: Deploy Backend to Railway

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Deploying all services to Railway..."
          railway up -d

      - name: Run database migrations
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Running database migrations..."
          # Railway will auto-run schema.sql on first deploy
          
      - name: Health check
        run: |
          echo "Waiting for services to start..."
          sleep 30
          # Add health check endpoint once deployed
          # curl https://your-app.up.railway.app/health

      - name: Deployment Summary
        run: |
          echo "âœ… Backend deployed successfully to Railway!"
          echo "ðŸ“Š Check Railway dashboard for logs and metrics"
          echo "ðŸ”— API URL will be available in Railway project settings"
